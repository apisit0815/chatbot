<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dr.APisit's STEM Classroom Chatbot</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7fafc; --panel:#ffffff; --text:#1a202c; --muted:#6b7280;
      --accent:#2563eb; --accent-weak:#eef2ff; --border:#e5e7eb; --bubble:#f1f5f9; --ok:#10b981; --warn:#ef4444;
    }
    .dark{
      --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#60a5fa; --accent-weak:#0b2942; --border:#1f2937; --bubble:#111827; --ok:#34d399; --warn:#f87171;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:"Noto Sans Thai", system-ui, sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; justify-content:center; padding:16px;
    }
    .app{ width:100%; max-width:920px; display:flex; flex-direction:column; gap:12px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); overflow:hidden; }
    .header{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), #22d3ee); color:white; font-weight:700; }
    .title{ font-weight:700; letter-spacing:.2px }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .sel, .sliderWrap, .toggle{
      border:1px solid var(--border); background:transparent; color:var(--text);
      padding:8px 10px; border-radius:10px;
    }
    .sel{ min-width: 160px; }
    .sliderWrap{ display:flex; align-items:center; gap:8px; }
    .sliderWrap input{ accent-color: var(--accent); }
    .toggle{ cursor:pointer; }
    .chat{ height:min(60vh, 560px); overflow:auto; padding:18px; background:linear-gradient(180deg, transparent, rgba(0,0,0,.02)); scroll-behavior:smooth; }
    .empty{ color:var(--muted); text-align:center; margin-top:18px; font-size:14px; }
    .row{ display:flex; gap:10px; margin:10px 0; }
    .row.user{ justify-content:flex-end; }
    .avatar{ width:32px; height:32px; border-radius:10px; display:grid; place-items:center; font-size:14px; background:var(--bubble); color:var(--muted); flex:0 0 auto; }
    .bubble{ max-width:78%; padding:10px 12px; border-radius:14px; line-height:1.45; word-wrap:break-word; border:1px solid var(--border); background:var(--panel); }
    .user .bubble{ background:var(--accent-weak); border-color:transparent; }
    .assistant .bubble{ background:var(--panel); }
    .composer{ display:flex; gap:10px; padding:12px; border-top:1px solid var(--border); }
    textarea{ flex:1; resize:none; min-height:44px; max-height:140px; padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text); outline:none; }
    textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
    .send{ height:44px; padding:0 16px; border:none; border-radius:12px; cursor:pointer; background:var(--accent); color:white; font-weight:600; box-shadow:0 8px 16px rgba(37,99,235,.35); }
    .send:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none }
    .footbar{ display:flex; justify-content:space-between; align-items:center; padding:0 12px 12px 12px; font-size:12px; color:var(--muted); }
    .count{ color:var(--muted); }
    .count.warn{ color: var(--warn); }
    .meta{ color: var(--ok); }
    .typing{ font-size:12px; color:var(--muted); padding:0 16px 12px }
    .toast{ position:fixed; inset:auto 16px 16px auto; background:var(--warn); color:white; padding:10px 12px; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.18); display:none; }
    @media (max-width: 560px){ .bubble{ max-width:88% } .title{ font-size:16px } .sel{ min-width: 130px; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="brand">
          <div class="logo">AI</div>
          <div>
            <div class="title">STEM Classroom Chatbot</div>
            <div style="font-size:12px;color:var(--muted)">‡πÇ‡∏Ñ‡πâ‡∏ä/‡∏ü‡∏≤‡∏ã‡∏¥‡∏•‡∏¥‡πÄ‡∏ó‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‚Äì‡∏°‡∏±‡∏ò‡∏¢‡∏° (‡∏à‡∏≥‡∏Å‡∏±‡∏î 500 tokens ‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å)</div>
          </div>
        </div>

        <div class="controls">
          <select id="mode" class="sel" title="‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö">
            <option value="coach">Coach (‡∏ñ‡∏≤‡∏°‡∏ô‡∏≥ ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏î)</option>
            <option value="teacher">Teacher (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô)</option>
            <option value="tutor">Tutor (‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô)</option>
          </select>

          <select id="grade" class="sel" title="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô">
            <option value="primary">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°</option>
            <option value="lowersec" selected>‡∏°.‡∏ï‡πâ‡∏ô</option>
            <option value="uppersec">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</option>
          </select>

          <div class="sliderWrap" title="Temperature: ‡∏ï‡πà‡∏≥=‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏™‡∏π‡∏á=‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå">
            <label for="temp">Temp</label>
            <input id="temp" type="range" min="0" max="1" step="0.1" value="0.5">
            <span id="tempVal">0.5</span>
          </div>

          <button class="toggle" id="modeBtn" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏á/‡∏°‡∏∑‡∏î">üåô</button>
        </div>
      </div>

      <div id="chat" class="chat">
        <div class="empty">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚§µÔ∏é</div>
      </div>

      <div class="typing" id="typing" style="display:none">ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‚Ä¶</div>

      <div class="composer">
        <textarea id="q" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Enter = ‡∏™‡πà‡∏á, Shift+Enter = ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)"></textarea>
        <button class="send" id="sendBtn">‡∏™‡πà‡∏á</button>
      </div>

      <div class="footbar">
        <div id="tokCount" class="count">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 0 / 500 tokens</div>
        <div id="metaBar" class="meta"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>

  <script>
    // ======= ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Apps Script =======
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzd5R6d7i1v8Rm827CaP1KB9AcKWb9F_SXuZ2-jtBltfpolkhWN-3E5cJKvPQaiEuCF/exec"; // ‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy

    // ======= DOM helpers =======
    const chat = document.getElementById("chat");
    const q = document.getElementById("q");
    const sendBtn = document.getElementById("sendBtn");
    const typing = document.getElementById("typing");
    const toast = document.getElementById("toast");
    const modeBtn = document.getElementById("modeBtn");
    const tempSlider = document.getElementById("temp");
    const tempVal = document.getElementById("tempVal");
    const tokCount = document.getElementById("tokCount");
    const metaBar = document.getElementById("metaBar");
    const modeSel = document.getElementById("mode");
    const gradeSel = document.getElementById("grade");

    // ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á
    const applyTheme = () => {
      const m = localStorage.getItem("theme") || "light";
      document.documentElement.classList.toggle("dark", m === "dark");
      modeBtn.textContent = m === "dark" ? "‚òÄÔ∏è" : "üåô";
    };
    modeBtn.onclick = () => {
      const next = (localStorage.getItem("theme") || "light") === "light" ? "dark" : "light";
      localStorage.setItem("theme", next); applyTheme();
    };
    applyTheme();

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ temp ‡∏™‡∏î‡πÜ
    tempSlider.addEventListener("input", ()=> tempVal.textContent = tempSlider.value);
    tempVal.textContent = tempSlider.value;

    // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì token ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á Apps Script
    function estimateTokensClient(s){
      if(!s) return 0;
      const ascii = (s.match(/[\x00-\x7F]/g) || []).length;
      const nonAscii = s.length - ascii;
      return Math.ceil(ascii/4) + Math.ceil(nonAscii/2);
    }
    function updateCounter(){
      const t = estimateTokensClient(q.value);
      tokCount.textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${t} / 500 tokens`;
      tokCount.className = "count" + (t>500 ? " warn" : "");
    }
    q.addEventListener("input", updateCounter); updateCounter();

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢; ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÉ‡∏ä‡πâ localStorage ‡πÑ‡∏î‡πâ)
    let history = [];

    function addMessage(role, text){
      const row = document.createElement("div");
      row.className = `row ${role}`;
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = role === "user" ? "‡∏Ñ‡∏∏‡∏ì" : "AI";
      const bubble = document.createElement("div");
      bubble.className = `bubble ${role}`;
      bubble.textContent = text;
      const wrap = document.createElement("div"); wrap.appendChild(bubble);
      if(role === "user"){ row.appendChild(wrap); row.appendChild(avatar); }
      else{ row.appendChild(avatar); row.appendChild(wrap); }
      chat.appendChild(row);
      chat.querySelector(".empty")?.remove();
      chat.scrollTop = chat.scrollHeight;
    }

    function setTyping(v){ typing.style.display = v ? "block" : "none"; }
    function setSending(v){ sendBtn.disabled = v; }
    function showToast(msg){
      toast.textContent = msg; toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display = "none", 2400);
    }

    async function sendMessage(){
      const text = q.value.trim();
      if(!text) return;

      // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 500 tokens
      const t = estimateTokensClient(text);
      if (t > 500){
        showToast("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 500 tokens ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
        return;
      }

      addMessage("user", text);
      history.push({ role: "user", content: text });
      q.value = ""; updateCounter(); setTyping(true); setSending(true);
      metaBar.textContent = "";  // ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

      try{
        const payload = {
          messages: history,             // server ‡∏à‡∏∞‡πÉ‡∏™‡πà system prompt ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏° mode/grade
          mode: modeSel.value,           // coach | teacher | tutor
          grade: gradeSel.value,         // primary | lowersec | uppersec
          temperature: Number(tempSlider.value) // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏ó‡∏µ‡πà server
        };

        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"text/plain" }, // simple request ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS preflight
          body: JSON.stringify(payload)
        });

        // ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô text ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ server ‡∏™‡πà‡∏á text/plain ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        const raw = await res.text();
        let data;
        try{ data = JSON.parse(raw); } catch{ data = { error: "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" }; }

        if (data.error){
          addMessage("assistant", "‚ö†Ô∏è " + data.error);
        } else {
          addMessage("assistant", data.reply || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)");
          // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•/‡πÇ‡∏´‡∏°‡∏î/‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‡∏à‡∏≤‡∏Å meta ‡∏ó‡∏µ‡πà server ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
          if (data.meta){
            const { ms, grade, mode, temperature } = data.meta;
            metaBar.textContent = `‚è± ${ms} ms ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î: ${mode} ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${grade} ‚Ä¢ temp: ${temperature}`;
          }
          history.push({ role:"assistant", content: data.reply });
        }

      }catch(err){
        showToast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
      }finally{
        setTyping(false); setSending(false);
      }
    }

    // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î: Enter = ‡∏™‡πà‡∏á, Shift+Enter = ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
    q.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
    sendBtn.addEventListener("click", (e)=>{ e.preventDefault(); sendMessage(); });
  </script>
</body>
</html>
