<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dr.Apisit‚Äôs STEM classroom chatbot</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* ===== THEME: STEM Aqua-Teal ===== */
    :root{
      --bg:#eef6ff; --bg2:#e7fbff;
      --panel:#ffffff; --text:#0f172a; --muted:#64748b;
      --accent:#14b8a6; --accent-weak:#ccfbf1; --border:#dbeafe; --bubble:#f8fafc;
      --ok:#0d9488; --warn:#ef4444;
      --shadow:0 8px 24px rgba(15,23,42,.08);
    }
    .dark{
      --bg:#0f172a; --bg2:#0b1220;
      --panel:#111826; --text:#e2e8f0; --muted:#94a3b8;
      --accent:#2dd4bf; --accent-weak:#0d9488; --border:#223047; --bubble:#0c1220;
      --ok:#5eead4; --warn:#f87171;
      --shadow:0 12px 28px rgba(0,0,0,.32);
    }

    /* ===== RESET / FULL-HEIGHT ===== */
    *{ box-sizing:border-box }
    html, body{ height:100%; width:100%; margin:0 }
    body{
      font-family:"Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, var(--bg2), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, var(--accent-weak), transparent 50%),
        var(--bg);
      padding: max(0px, env(safe-area-inset-top)) max(0px, env(safe-area-inset-right))
               max(0px, env(safe-area-inset-bottom)) max(0px, env(safe-area-inset-left));
    }

    /* ===== APP LAYOUT: 100% viewport height ===== */
    .app{
      width:100vw;
      height:100dvh;          /* viewport ‡∏™‡∏π‡∏á‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: clamp(8px, 2vw, 16px);
    }
    @supports (-webkit-touch-callout: none) { .app{ height:-webkit-fill-available; } }

    /* ===== CARD ===== */
    .card{
      flex:1;
      display:flex; flex-direction:column;
      max-width:1400px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ===== HEADER ===== */
    .header{
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:center; justify-content:space-between;
      padding:16px 18px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.5));
      backdrop-filter: blur(6px);
      position:sticky; top:0; z-index:10;
    }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{
      width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(135deg, var(--accent), #22d3ee); color:white; font-weight:700;
      box-shadow: 0 6px 14px rgba(20,184,166,.35);
    }
    .title{ font-weight:700; letter-spacing:.2px }
    .subtitle{ font-size:12px; color:var(--muted) }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .sel, .sliderWrap, .toggle{
      border:1px solid var(--border); background:transparent; color:var(--text);
      padding:8px 10px; border-radius:12px;
    }
    .sel{ min-width: 170px }
    .sliderWrap{ display:flex; align-items:center; gap:8px }
    .sliderWrap input{ accent-color: var(--accent) }
    .toggle{ cursor:pointer }

    /* ===== CHAT AREA ===== */
    .chat{
      flex:1; min-height:0; overflow:auto;
      padding:22px clamp(12px, 2vw, 26px);
      background:linear-gradient(180deg, transparent, rgba(0,0,0,.02));
      scroll-behavior:smooth;
    }
    .empty{ color:var(--muted); text-align:center; margin-top:18px; font-size:14px }

    .row{ display:flex; gap:10px; margin:10px 0 }
    .row.user{ justify-content:flex-end }
    .avatar{
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center; font-size:14px;
      background:var(--bubble); color:var(--muted); flex:0 0 auto;
    }
    .bubble{
      max-width: min(980px, 92vw);
      padding:12px 14px; border-radius:16px; line-height:1.55; word-wrap:break-word;
      border:1px solid var(--border); background:var(--panel);
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .user .bubble{ background:var(--accent-weak); border-color: transparent }
    .assistant .bubble{ background:var(--panel) }

    /* ===== COMPOSER ===== */
    .composer{
      display:flex; gap:10px; align-items:center;
      padding: 12px clamp(12px, 2vw, 18px);
      border-top:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.9));
      backdrop-filter: blur(6px);
      position:sticky; bottom:0; z-index:10;
    }
    textarea{
      flex:1; resize:none; min-height:48px; max-height:38dvh;
      padding:12px 14px; border-radius:14px; border:1px solid var(--border);
      background:var(--panel); color:var(--text); outline:none;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
    }
    textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(20,184,166,.18) }
    .actions{ display:flex; gap:10px }
    .send{
      height:44px; padding:0 16px; border:none; border-radius:12px; cursor:pointer;
      background:var(--accent); color:white; font-weight:600; box-shadow:0 8px 16px rgba(20,184,166,.35);
    }
    .send.alt{ background: var(--ok) }
    .send:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none }

    /* ===== FOOT ===== */
    .footbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px clamp(12px, 2vw, 18px); font-size:12px; color:var(--muted);
      border-top:1px solid var(--border);
      background: var(--panel);
    }
    .count{ color:var(--muted) }
    .count.warn{ color: var(--warn) }
    .meta{ color: var(--ok) }

    .typing{ font-size:12px; color:var(--muted); padding:0 clamp(12px, 2vw, 18px) 10px }

    .toast{
      position:fixed; right:16px; bottom:16px;
      background:var(--warn); color:white; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); display:none;
    }

    @media (max-width: 560px){
      .sel{ min-width:140px }
      .bubble{ max-width:94vw }
      .title{ font-size:16px }
    }

    /* cursor for typewriter effect */
    .cursor{ display:inline-block; width:8px; height:1em; vertical-align:bottom;
      background:currentColor; margin-left:2px; animation:blink 1s steps(1) infinite }
    @keyframes blink { 50%{ opacity:0 } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <!-- Header -->
      <div class="header">
        <div class="brand">
          <div class="logo">AI</div>
          <div>
            <div class="title">Dr.Apisit‚Äôs STEM classroom chatbot</div>
            <div class="subtitle">‡πÇ‡∏Ñ‡πâ‡∏ä/‡∏ü‡∏≤‡∏ã‡∏¥‡∏•‡∏¥‡πÄ‡∏ó‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‚Äì‡∏°‡∏±‡∏ò‡∏¢‡∏° (‡∏à‡∏≥‡∏Å‡∏±‡∏î 500 ‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å)</div>
          </div>
        </div>

        <div class="controls">
          <select id="mode" class="sel" title="‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö">
            <option value="coach">‡πÇ‡∏´‡∏°‡∏î Coach (‡∏ñ‡∏≤‡∏°‡∏ô‡∏≥ ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏î)</option>
            <option value="teacher">‡πÇ‡∏´‡∏°‡∏î Teacher (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô)</option>
            <option value="tutor">‡πÇ‡∏´‡∏°‡∏î Tutor (‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô)</option>
          </select>

          <select id="grade" class="sel" title="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô">
            <option value="primary">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
            <option value="lowersec" selected>‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏ï‡πâ‡∏ô</option>
            <option value="uppersec">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏õ‡∏•‡∏≤‡∏¢</option>
          </select>

          <div class="sliderWrap" title="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå: ‡∏ï‡πà‡∏≥=‡∏ï‡∏≠‡∏ö‡∏ï‡∏£‡∏á ‡∏™‡∏π‡∏á=‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå">
            <label for="temp">Temperature</label>
            <input id="temp" type="range" min="0" max="1" step="0.1" value="0.5">
            <span id="tempVal">0.5</span>
          </div>

          <button class="toggle" id="modeBtn" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏á/‡∏°‡∏∑‡∏î">üåô</button>
        </div>
      </div>

      <!-- Chat area -->
      <div id="chat" class="chat">
        <div class="empty">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚§µÔ∏é</div>
      </div>

      <div class="typing" id="typing" style="display:none">ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‚Ä¶</div>

      <!-- Composer -->
      <div class="composer">
        <textarea id="q" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Enter = ‡∏™‡πà‡∏á, Shift+Enter = ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)"></textarea>
        <div class="actions">
          <button class="send" id="sendBtn">‡∏™‡πà‡∏á</button>
        </div>
      </div>

      <!-- Footer info -->
      <div class="footbar">
        <div id="tokCount" class="count">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 0 / 500 ‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô</div>
        <div id="metaBar" class="meta"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>

  <script>
    /* ===== CONFIG: ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script Web App ===== */
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzd5R6d7i1v8Rm827CaP1KB9AcKWb9F_SXuZ2-jtBltfpolkhWN-3E5cJKvPQaiEuCF/exec"; // ‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/AKfycb.../exec

    /* ===== DOM ===== */
    const chat = document.getElementById("chat");
    const q = document.getElementById("q");
    const sendBtn = document.getElementById("sendBtn");
    const skipBtn = document.getElementById("skipBtn");
    const typing = document.getElementById("typing");
    const toast = document.getElementById("toast");
    const modeBtn = document.getElementById("modeBtn");
    const tempSlider = document.getElementById("temp");
    const tempVal = document.getElementById("tempVal");
    const tokCount = document.getElementById("tokCount");
    const metaBar = document.getElementById("metaBar");
    const modeSel = document.getElementById("mode");
    const gradeSel = document.getElementById("grade");

    /* ===== Theme toggle ===== */
    const applyTheme = () => {
      const m = localStorage.getItem("theme") || "light";
      document.documentElement.classList.toggle("dark", m === "dark");
      modeBtn.textContent = m === "dark" ? "‚òÄÔ∏è" : "üåô";
    };
    modeBtn.onclick = () => {
      const next = (localStorage.getItem("theme") || "light") === "light" ? "dark" : "light";
      localStorage.setItem("theme", next); applyTheme();
    };
    applyTheme();

    /* temp show */
    tempSlider.addEventListener("input", ()=> tempVal.textContent = tempSlider.value);
    tempVal.textContent = tempSlider.value;

    /* ===== Token estimate (matches server heuristic) ===== */
    function estimateTokensClient(s){
      if(!s) return 0;
      const ascii = (s.match(/[\x00-\x7F]/g) || []).length;
      const nonAscii = s.length - ascii;
      return Math.ceil(ascii/4) + Math.ceil(nonAscii/2);
    }
    function updateCounter(){
      const t = estimateTokensClient(q.value);
      tokCount.textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${t} / 500 ‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô`;
      tokCount.className = "count" + (t>500 ? " warn" : "");
    }
    q.addEventListener("input", updateCounter); updateCounter();

    /* ===== Chat state ===== */
    let history = [];
    let typingController = { skipping:false };

    /* ===== UI helpers ===== */
    function addMessage(role, text){
      const row = document.createElement("div");
      row.className = `row ${role}`;
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = role === "user" ? "‡∏Ñ‡∏∏‡∏ì" : "Dr.";
      const bubble = document.createElement("div");
      bubble.className = `bubble ${role}`;
      bubble.textContent = text;
      const wrap = document.createElement("div"); wrap.appendChild(bubble);
      if(role === "user"){ row.appendChild(wrap); row.appendChild(avatar); }
      else{ row.appendChild(avatar); row.appendChild(wrap); }
      chat.appendChild(row);
      chat.querySelector(".empty")?.remove();
      chat.scrollTop = chat.scrollHeight;
    }

    function addAssistantBubble() {
      const row = document.createElement("div");
      row.className = "row assistant";
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = "Dr.";
      const bubble = document.createElement("div");
      bubble.className = "bubble assistant";
      const wrap = document.createElement("div"); wrap.appendChild(bubble);
      row.appendChild(avatar); row.appendChild(wrap);
      chat.appendChild(row);
      chat.querySelector(".empty")?.remove();
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    function setTyping(v){ typing.style.display = v ? "block" : "none"; }
    function setSending(v){ sendBtn.disabled = v; skipBtn.disabled = v; }
    function showToast(msg){
      toast.textContent = msg; toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display = "none", 2400);
    }

    /* ===== Typewriter effect ===== */
    async function typeOutToBubble(text, bubbleEl, opts = {}) {
      const speed = opts.speed ?? 10;   // characters per batch
      const delay = opts.delay ?? 18;   // ms per batch
      const cursor = document.createElement("span");
      cursor.className = "cursor";
      bubbleEl.textContent = "";
      bubbleEl.appendChild(cursor);

      const chars = text.split("");
      let buffer = "";

      function flushBuffer() {
        if (!buffer) return;
        const safeSpan = document.createElement("span");
        safeSpan.textContent = buffer;
        bubbleEl.insertBefore(safeSpan, cursor);
        buffer = "";
      }

      typingController.skipping = false;
      for (let i = 0; i < chars.length; i++) {
        if (typingController.skipping) {
          flushBuffer();
          const rest = document.createElement("span");
          rest.textContent = chars.slice(i).join("");
          bubbleEl.insertBefore(rest, cursor);
          break;
        }
        const ch = chars[i];
        if (ch === "\n") { flushBuffer(); bubbleEl.insertBefore(document.createElement("br"), cursor); }
        else { buffer += ch; }
        flushBuffer();
        if (i % speed === 0) await new Promise(r => setTimeout(r, delay));
        chat.scrollTop = chat.scrollHeight;
      }
      cursor.remove();
    }
    skipBtn.addEventListener("click", ()=> typingController.skipping = true);

    /* ===== Send flow ===== */
    async function sendMessage(){
      const text = q.value.trim();
      if(!text) return;

      const t = estimateTokensClient(text);
      if (t > 500){
        showToast("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 500 ‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
        return;
      }

      addMessage("user", text);
      history.push({ role: "user", content: text });
      q.value = ""; updateCounter(); setTyping(true); setSending(true);
      metaBar.textContent = "";

      try{
        const payload = {
          messages: history,
          mode: modeSel.value,       // coach | teacher | tutor
          grade: gradeSel.value,     // primary | lowersec | uppersec
          temperature: Number(tempSlider.value)
        };

        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"text/plain" }, // simple request ‡∏•‡∏î preflight
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let data;
        try{ data = JSON.parse(raw); } catch{ data = { error: "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" }; }

        if (data.error){
          addMessage("assistant", "‚ö†Ô∏è " + data.error);
        } else {
          const bubble = addAssistantBubble();
          const replyText = data.reply || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)";
          await typeOutToBubble(replyText, bubble, { speed: 10, delay: 18 });

          if (data.meta){
            const { ms, grade, mode, temperature } = data.meta;
            metaBar.textContent = `‚è± ${ms} ms ‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î: ${mode} ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${grade} ‚Ä¢ temp: ${temperature}`;
          }
          history.push({ role:"assistant", content: replyText });
        }

      }catch(err){
        showToast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
      }finally{
        setTyping(false); setSending(false);
      }
    }

    // Enter = ‡∏™‡πà‡∏á, Shift+Enter = ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
    q.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
    sendBtn.addEventListener("click", (e)=>{ e.preventDefault(); sendMessage(); });
  </script>
</body>
</html>

